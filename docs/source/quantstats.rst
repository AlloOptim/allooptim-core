.. _quantstats-integration:

QuantStats Integration
=======================

AlloOptim integrates with `QuantStats <https://github.com/ranaroussi/quantstats>`_ to provide professional-grade portfolio performance analysis and reporting. QuantStats generates comprehensive HTML tearsheets that are widely used in the quantitative finance industry.

Overview
--------

QuantStats provides:

* **50+ Performance Metrics**: Beyond the standard Sharpe, Sortino, and Calmar ratios
* **Risk Analysis**: Value-at-Risk (VaR), Conditional VaR (CVaR), maximum drawdown analysis
* **Benchmark Comparison**: Alpha, beta, information ratio, and tracking error
* **Interactive Visualizations**: Monthly returns heatmaps, rolling statistics, drawdown periods
* **Professional Reports**: HTML tearsheets suitable for institutional presentations

Installation
------------

QuantStats is an optional dependency. Install it with:

.. code-block:: bash

    # Using Poetry
    poetry install --with visualizations

    # Or using pip
    pip install quantstats

Usage
-----

Basic Usage
~~~~~~~~~~~

QuantStats reports are automatically generated when running backtests:

.. code-block:: python

    from allooptim.backtest import BacktestEngine, BacktestConfig

    config = BacktestConfig(
        start_date="2020-01-01",
        end_date="2024-01-01",
        generate_quantstats_reports=True,  # Enable QuantStats
        quantstats_mode="full",             # "basic" or "full"
        quantstats_top_n=5                  # Top N performers to analyze
    )

    engine = BacktestEngine(config)
    results = engine.run_backtest()

    # QuantStats reports are saved to:
    # backtest_results/{timestamp}/quantstats_reports/

Standalone Usage
~~~~~~~~~~~~~~~~

You can also generate QuantStats reports programmatically:

.. code-block:: python

    from allooptim.backtest.backtest_quantstats import (
        generate_tearsheet,
        calculate_quantstats_metrics,
        QUANTSTATS_AVAILABLE
    )

    if QUANTSTATS_AVAILABLE:
        # Generate HTML tearsheet
        generate_tearsheet(
            results,
            optimizer_name="MaxSharpeOptimizer",
            benchmark="SPY",
            output_path="reports/max_sharpe.html"
        )

        # Get metrics programmatically
        metrics = calculate_quantstats_metrics(
            results,
            "MaxSharpeOptimizer",
            benchmark="SPY"
        )
        print(f"Sharpe: {metrics['sharpe']:.2f}")
        print(f"VaR 95%: {metrics['var_95']:.2%}")

Configuration Options
---------------------

The following configuration options control QuantStats behavior:

.. code-block:: python

    config = BacktestConfig(
        # Enable/disable QuantStats reports
        generate_quantstats_reports=True,

        # Report mode: "basic" or "full"
        quantstats_mode="full",

        # Number of top performers to analyze
        quantstats_top_n=5,

        # Generate individual tearsheets for each optimizer
        quantstats_individual=True
    )

Report Types
------------

Markdown Reports (Default)
~~~~~~~~~~~~~~~~~~~~~~~~~~

* Generated by default
* Text-based tables and summaries
* Fast generation
* Suitable for quick analysis and documentation

HTML Tearsheets (QuantStats)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

* Professional interactive reports
* 50+ performance metrics
* Interactive charts and visualizations
* Benchmark comparison
* Institutional-grade presentation
* Slower generation due to HTML rendering

When to Use Each
~~~~~~~~~~~~~~~~~

**Use Markdown Reports when:**
* You need quick results
* You're doing exploratory analysis
* You want to include results in documentation
* Performance is critical

**Use HTML Tearsheets when:**
* You need professional presentation
* You're analyzing for institutional clients
* You want comprehensive risk analysis
* Interactive exploration is valuable

Available Metrics
-----------------

QuantStats provides extensive performance metrics:

Risk-Adjusted Returns
~~~~~~~~~~~~~~~~~~~~~

* **Sharpe Ratio**: Risk-adjusted return using standard deviation
* **Sortino Ratio**: Risk-adjusted return using downside deviation
* **Calmar Ratio**: Return relative to maximum drawdown
* **Omega Ratio**: Probability-weighted ratio of gains vs losses

Risk Metrics
~~~~~~~~~~~~

* **Value at Risk (VaR)**: Maximum expected loss over a period
* **Conditional VaR (CVaR)**: Expected loss beyond VaR
* **Maximum Drawdown**: Largest peak-to-trough decline
* **Ulcer Index**: Measure of downside volatility

Return Metrics
~~~~~~~~~~~~~~

* **Compound Annual Growth Rate (CAGR)**: Geometric annualized return
* **Total Return**: Cumulative return over the period
* **Best/Worst Day**: Single-day extreme returns
* **Recovery Factor**: Return relative to maximum drawdown

Win/Loss Analysis
~~~~~~~~~~~~~~~~~

* **Win Rate**: Percentage of positive return periods
* **Profit Factor**: Gross profits divided by gross losses
* **Payoff Ratio**: Average win divided by average loss

Benchmark-Relative Metrics
~~~~~~~~~~~~~~~~~~~~~~~~~~

* **Alpha**: Excess return relative to benchmark
* **Beta**: Market sensitivity/volatility relative to benchmark
* **Information Ratio**: Risk-adjusted active return
* **R-Squared**: Proportion of variance explained by benchmark

Advanced Metrics
~~~~~~~~~~~~~~~~

* **Tail Ratio**: Ratio of positive to negative tail returns
* **Common Sense Ratio**: Comprehensive risk-adjusted measure
* **Kappa**: Generalized Sharpe ratio
* **Gain-to-Pain Ratio**: Return relative to absolute drawdown

Troubleshooting
---------------

QuantStats Not Available
~~~~~~~~~~~~~~~~~~~~~~~~

If QuantStats reports are not generated:

1. Check installation:

   .. code-block:: bash

       poetry install --with visualizations

2. Verify import:

   .. code-block:: python

       from allooptim.backtest.backtest_quantstats import QUANTSTATS_AVAILABLE
       print(QUANTSTATS_AVAILABLE)  # Should be True

3. Check logs for import errors

Report Generation Errors
~~~~~~~~~~~~~~~~~~~~~~~~

Common issues:

* **Insufficient data**: QuantStats needs at least 10 data points
* **Invalid returns**: Check for NaN values or incorrect datetime index
* **Benchmark issues**: Ensure benchmark data is available or use valid ticker

Performance Considerations
~~~~~~~~~~~~~~~~~~~~~~~~~~

* HTML generation is slower than Markdown reports
* Large backtests may take several seconds per optimizer
* Consider disabling for quick debugging runs

Integration with Existing Workflow
----------------------------------

QuantStats integrates seamlessly with AlloOptim's existing backtesting:

1. **Automatic Generation**: Reports are created alongside existing Markdown reports
2. **Optional Dependency**: No impact if QuantStats is not installed
3. **Configuration Control**: Easy to enable/disable via BacktestConfig
4. **Directory Structure**: Reports saved in ``quantstats_reports/`` subdirectory

Example Output Structure
~~~~~~~~~~~~~~~~~~~~~~~~

::

    backtest_results/
    ├── 20251109_143000/           # Timestamped results directory
    │   ├── backtest_results.csv   # CSV summary
    │   ├── comprehensive_backtest_report.md  # Markdown report
    │   └── quantstats_reports/    # QuantStats HTML reports
    │       ├── MaxSharpeOptimizer_tearsheet.html
    │       ├── HRPOptimizer_tearsheet.html
    │       ├── RiskParityOptimizer_tearsheet.html
    │       └── comparative_analysis.html

API Reference
-------------

.. automodule:: allooptim.backtest.backtest_quantstats
   :members:
   :undoc-members:
   :show-inheritance: